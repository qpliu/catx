#!/bin/sh
set -e
if test '!' -f "../buildBin"
then
    echo "Wrong directory"
    exit 1
fi
pwd=`pwd`
name=`basename "$pwd"`
PARTS=`grep '^% BIN ' music|cut -c 7-`
if test -n "$PARTS"
then
    echo "$name"
    ../build1 $PARTS
    cd ..
    GGPDF_FILE=
    MIDI_FILE=
    ROBOT_FILE=
    for a in bin/bin/*
    do
	b=`basename "$a"`
	case "$a" in
	    *.pdf)
		case "$b" in
		    *_gg.pdf)
			GGPDF_FILE="$a"
			;;
		esac
		if test -f "../bin/$b"
		then
		    ./get_rid_of_id_in_pdf.py <"$a" >bin/1
		    ./get_rid_of_id_in_pdf.py <"../bin/$b" >bin/2
		    if cmp -s bin/1 bin/2
		    then
			touch ../bin/"$b"
			continue
		    fi
		fi
		cp "$a" ../bin/
		;;
	    *.midi)
		MIDI_FILE="../robot/$b"
		cp "$a" ../bin/
		;;
	    *.robot)
		ROBOT_FILE="$a"
		;;
	    *)
		cp "$a" ../bin/
		;;
	esac
    done
    if test -n "$GGPDF_FILE"
    then
	b=`basename "$GGPDF_FILE" _gg.pdf`
	(
	    test -n "$ROBOT_FILE"&&cat "$ROBOT_FILE"
	    echo "pdf_file=../pdf/${b}_gg.pdf"
	    echo "midi_file=$MIDI_FILE"
	)>"/share/music/aarin/$b.aarin"
    fi
fi
