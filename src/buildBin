#!/bin/sh
if test '!' -f "../buildBin"
then
    echo "Wrong directory.  Run this from one of src/*/ directories."
    exit 1
fi
pwd=`pwd`
name=`basename "$pwd"`
set -e
PARTS=`grep '^% BIN ' music|cut -c 7-`
if test -n "$PARTS"
then
    (
	echo "$name"
	mkdir -p ../../bin/"$name"
	../../build/build $PARTS
	cd ../../build
	for a in bin/bin/*
	do
	    b=`basename "$a"`
	    case "$a" in
		*.pdf)
		    if test -f "../bin/$name/$b"
		    then
			./get_rid_of_id_in_pdf.py <"$a" >bin/1
			./get_rid_of_id_in_pdf.py <"../bin/$name/$b" >bin/2
			if cmp -s bin/1 bin/2
			then
			    touch ../bin/"$name/$b"
			    continue
			fi
		    fi
		    cp "$a" ../bin/"$name"
		    ;;
		*.midi)
		    cp "$a" ../bin/"$name"
		    ;;
	    esac
	done
    )2>&1|tee "../../bin/$name/log"
fi
