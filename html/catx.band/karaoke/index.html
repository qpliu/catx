<!doctype html> 
<html>
<head>
<meta charset=UTF-8>
<title id=title>Karaoke</title>
</head>
<div style=text-align:center;><span id=name style=font-size:300%;color:#0f0;background-color:#000;>Start playing a song with Aarin Robo to sing karaoke!</span></div>
<div style=text-align:center;><span id=beat_counter style=font-size:400%;color:#000;background-color:#0f0;>1</span></div>
<br>
<div style=display:inline-block;margin-top:10%;width:10%;text-align:center;font-size:150%;><span id=line1at style=color:#0f0;background-color:#000;></span></div><span id=line1 style=display:inline-block;margin-top:10%;font-size:150%;></span>
<br>
<div style=display:inline-block;margin-top:10%;margin-left:10%;width:10%;text-align:center;font-size:150%;><span id=line0at style=color:#0f0;background-color:#000;></span></div><span id=line0 style=display:inline-block;margin-top:10%;margin-left:5%;font-size:150%;></span>
<br>
<div style=text-align:right;><span id=lineatat style=display:inline-block;margin-top:10%;></span></div>
<br>
<img style=position:absolute; id=ball src=../ball.png width=50 />
<script>
    var DELAY=200;
    var HZ=30;
    var websocket=new WebSocket("wss://catx.band/karaoke_websocket");
    var ntp_t0;
    var ntp_offset;
    var karaoke;
    var beat_index;
    var karaoke_index;
    var start_time;
    var title=document.getElementById("title");
    var ball=document.getElementById("ball");
    var beat_counter=document.getElementById("beat_counter");
    var nname=document.getElementById("name");
    var line0at=document.getElementById("line0at");
    var line1at=document.getElementById("line1at");
    var lines=[document.getElementById("line0"),document.getElementById("line1")];
    var bounce_height=lines[0].getBoundingClientRect().top-lines[1].getBoundingClientRect().top;
    var which_line;
    var timeout=4;
    var send_ntp_count=0;
    var id_counter=0;
    var line_events;
    var next_line_start;
    var ball_x0,ball_y0,ball_t0;
    var ball_x1,ball_y1,ball_t1;
    websocket.onopen = function(){
	websocket.send("");
    };
    websocket.onmessage = function(event){
	var now=new Date().getTime();
	if (event.data.slice(0,1)=="t"){
	    timeout = 4;
	    var ntp_t1=parseInt(event.data.slice(1));
	    ntp_offset = (now+ntp_t0)/2-ntp_t1+DELAY;
	    console.log("ntp_offset="+ntp_offset);
	}
	if (event.data.slice(0,1)=="k"){
	    var json=JSON.parse(event.data.slice(1));
	    if (json.what=="karaoke"){
		nname.innerHTML = json.name;
		title.innerHTML = json.name;
		karaoke = json.karaoke;
		console.log(event.data.slice(1));
	    }
	    if (json.what=="start"){
		start_time = json.time+ntp_offset;
		karaoke_index = 0;
		next_line_start = 0;
		beat_index = 0;
		which_line = 0;
		ball_x0 = undefined;
		ball_x1 = undefined;
		line_events = [];
		lines[0].innerHTML = "";
		lines[1].innerHTML = "";
		console.log("Got start "+start_time+" now="+now);
	    }
	    if (json.what=="stop")
		start_time = undefined;
	}
    }
    window.setInterval(function(){
	if (start_time!=undefined){
	    var now=new Date().getTime();
	    if (next_line_start<now && karaoke_index<karaoke.length){
		which_line ^= 1;
		lines[which_line].innerHTML = "";
		var this_line_start;
		var this_line_end;
		while (karaoke_index<karaoke.length){
		    k = karaoke[karaoke_index].k;
		    t = karaoke[karaoke_index].t;
		    if (k.slice(0,1)!="^"){
			if (lines[which_line].innerHTML.length==0)
			    this_line_start = t;
			if (k.slice(0,1)==">"){
			    if (lines[which_line].innerHTML.length!=0){
				next_line_start = start_time+(2*this_line_start+this_line_end)/3;
				break;
			    }
			    k = k.slice(1);
			}
			this_line_end = t;
			if (k=="@@")
			    line_events.push([t,"lineatat"]);
			else if (k.slice(0,1)=="@"){
			    if (which_line==0)
				line_events.push([t,"line0at",k.slice(1)]);
			    else
				line_events.push([t,"line1at",k.slice(1)]);
			}else{
			    if (k.slice(0,1)=="-")
				k = k.slice(1);
			    else
				k = " "+k;
			    lines[which_line].innerHTML += "<slice id=id"+id_counter+" style=color:#000;>"+k+"</slice>";
			    line_events.push([t,"id"+id_counter]);
			    id_counter++;
			}
		    }
		    karaoke_index++;
		}
	    }
	    if (line_events.length!=0){
		if (ball_x0==undefined){
		    ball_t0 = start_time;
		    var rect=document.getElementById(line_events[0][1]).getBoundingClientRect();
		    ball_x0 = 0;
		    ball_y0 = rect.top;
		}
		if (ball_x1==undefined){
		    ball_t1 = start_time+line_events[0][0];
		    var rect=document.getElementById(line_events[0][1]).getBoundingClientRect();
		    ball_x1 = (rect.left+rect.right)/2;
		    ball_y1 = rect.top;
		}
	    }
	    if (ball_x1!=undefined){
		var tt=ball_t1-ball_t0;
		var t=(now-ball_t0)/tt;
		var rect=ball.getBoundingClientRect();
		ball.style.left = (ball_x0+t*(ball_x1-ball_x0)+(rect.left-rect.right)/2)+"px";
		if (tt>2000)
		    tt = 2000;
		ball.style.top = (ball_y0+t*(ball_y1-ball_y0)-rect.bottom+rect.top-(1-4*(t-.5)*(t-.5))*bounce_height*tt/2000)+"px";
	    }
	    while (line_events.length!=0 && start_time+line_events[0][0]<now){
		var element=document.getElementById(line_events[0][1]);
		if (line_events[0].length==3)
		    element.innerHTML = line_events[0][2];
		else
		    element.style.color = '#f00';
		line_events = line_events.slice(1);
		if (ball_x1!=undefined){
		    ball_t0 = ball_t1;
		    ball_x0 = ball_x1;
		    ball_y0 = ball_y1;
		    ball_x1 = undefined;
		}
	    }
	    while (beat_index<karaoke.length){
		k = karaoke[beat_index].k;
		if (k.slice(0,1)=="^"){
		    if (start_time+karaoke[beat_index].t>now)
			break;
		    beat_counter.innerHTML = k.slice(1);
		}
		beat_index++;
	    }
	}
	if (++send_ntp_count==HZ){
	    if (--timeout<0)
		location.reload();
	    ntp_t0 = new Date().getTime();
	    websocket.send("");
	    send_ntp_count = 0;
	}
    },1000/HZ);
</script>
</html>
