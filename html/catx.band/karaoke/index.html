<!doctype html> 
<html>
<head>
<meta charset=UTF-8>
<title id=title>Karaoke</title>
</head>
<body>
<img id=cat src=../cat/cat-0.png style=position:absolute;left:0;top:0;height:45vh;z-index:-1;>
<img id=graycat src=../cat/graycat-0.png style=position:absolute;left:20vw;top:5vh;height:30vh;z-index:-1;>
<img id=spin src=../cat/spin-0.png style=position:absolute;left:35vw;top:10vh;height:30vh;z-index:-1;>
<img id=pink src=../cat/pink-0.png style=position:absolute;left:50vw;top:6vh;height:30vh;z-index:-1;>
<img id=jump src=../cat/jump-0.png style=position:absolute;left:65vw;top:6vh;height:30vh;z-index:-1;>
<img id=fatcat src=../cat/fatcat-0.png style=position:absolute;right:0;top:0;height:40vh;z-index:-1;>
<div style=position:absolute;top:0;left:0;width:100vw;height:10vh;text-align:center;><span id=name style=font-size:6vh;white-space:nowrap;color:#0f0;background-color:#000;>Play a song with Aarin Robo to sing karaoke!</span></div>
<div style=position:absolute;top:10vh;left:0;width:100vw;height:10vh;text-align:center;><span id=beat_counter style=font-family:monospace;font-size:8vh;color:#000;background-color:#0f0;>1</span></div>
<div style=position:absolute;top:60vh;left:0;width:10vw;height:2vw;text-align:center;><span id=line1at style=position:absolute;font-size:2vw;color:#000;background-color:#0f0;></span></div>
<div style=position:absolute;top:60vh;left:10vw;width:90vw;height:2vw;><span id=line1 style=font-size:2vw;white-space:nowrap></span></div>
<div style=position:absolute;top:92vh;left:10vw;width:10vw;height:2vw;text-align:center;><span id=line0at style=position:absolute;font-size:2vw;color:#000;background-color:#0f0;></span></div>
<div style=position:absolute;top:92vh;left:20vw;width:80vw;height:2vw;><span id=line0 style=font-size:2vw;white-space:nowrap></span></div>
<div id=lineatat style=postion:absolute;top:100vh;left:100vw;width:0;height:0;></div>
<img style=position:absolute;bottom:100vh;width:10vh id=ball src=../ball.png>
<script>
    const DELAY=200;
    const cats=[
	["cat","../cat/cat-",40,8,0],
	["fatcat","../cat/fatcat-",8,2,0],
	["graycat","../cat/graycat-",4,1,0],
	["spin","../cat/spin-",18,2,0],
	["pink","../cat/pink-",8,2,0],
	["jump","../cat/jump-",8,4,0],
    ];
    const websocket=new WebSocket("wss://catx.band/karaoke_websocket");
    var last_beat_time;
    var ntp_t0;
    var ntp_offset;
    var karaoke;
    var karaoke_index;
    var start_time;
    var repeat_time;
    const title=document.getElementById("title");
    const ball=document.getElementById("ball");
    const beat_counter=document.getElementById("beat_counter");
    const nname=document.getElementById("name");
    const lines=[document.getElementById("line0"),document.getElementById("line1")];
    const bounce_height=lines[0].getBoundingClientRect().top-lines[1].getBoundingClientRect().top;
    var which_line;
    var timeout=4;
    var id_counter=0;
    var line_events;
    var beat_events;
    var next_line_start;
    var ball_x0,ball_y0,ball_t0;
    var ball_x1,ball_y1,ball_t1;
    function do_ntp(){
	if (--timeout<0)
	    location.reload();
	ntp_t0 = new Date().getTime();
	websocket.send("");
    }
    function animate(time){
	if (start_time==undefined)
	    return;
	const now=new Date().getTime();
	if (next_line_start<now && karaoke_index<karaoke.length){
	    which_line ^= 1;
	    lines[which_line].innerHTML = "";
	    let this_line_start;
	    let this_line_end;
	    for (; karaoke_index<karaoke.length; karaoke_index++){
		if ("repeat" in karaoke[karaoke_index]){
		    repeat_time += karaoke[karaoke_index].repeat;
		    karaoke_index = 0;
		    break;
		}
		let k=karaoke[karaoke_index].k;
		const t=karaoke[karaoke_index].t+repeat_time;
		if (k.slice(0,1)=="^")
		    beat_events.push([t,k.slice(1)]);
		else{
		    if (lines[which_line].innerHTML.length==0)
			this_line_start = t;
		    if (k.slice(0,1)==">"){
			if (lines[which_line].innerHTML.length!=0)
			    break;
			k = k.slice(1);
		    }
		    this_line_end = t;
		    if (k=="@@")
			line_events.push([t,"lineatat"]);
		    else if (k.slice(0,1)=="@"){
			if (which_line==0)
			    line_events.push([t,"line0at",k.slice(1)]);
			else
			    line_events.push([t,"line1at",k.slice(1)]);
		    }else{
			if (k.slice(0,1)=="-")
			    k = k.slice(1);
			else
			    k = " "+k;
			lines[which_line].innerHTML += "<span id=id"+id_counter+" style=color:#000;>"+k+"</span>";
			line_events.push([t,"id"+id_counter]);
			id_counter++;
		    }
		}
	    }
	    next_line_start = start_time+(2*this_line_start+this_line_end)/3;
	}
	if (line_events.length!=0){
	    const rect=document.getElementById(line_events[0][1]).getBoundingClientRect();
	    if (ball_x0==undefined){
		ball_t0 = start_time;
		ball_x0 = 0;
		ball_y0 = rect.top;
	    }
	    if (ball_x1==undefined){
		ball_t1 = start_time+line_events[0][0];
		ball_x1 = (rect.left+rect.right)/2;
		ball_y1 = rect.top;
	    }
	}
	if (ball_x1!=undefined){
	    let tt=ball_t1-ball_t0;
	    const t=(now-ball_t0)/tt;
	    const rect=ball.getBoundingClientRect();
	    ball.style.left = (ball_x0+t*(ball_x1-ball_x0)+(rect.left-rect.right)/2)+"px";
	    if (tt>2000)
		tt = 2000;
	    ball.style.top = (ball_y0+t*(ball_y1-ball_y0)-rect.bottom+rect.top-(1-4*(t-.5)*(t-.5))*bounce_height*tt/2000)+"px";
	}
	for (; line_events.length!=0&&start_time+line_events[0][0]<now; line_events=line_events.slice(1)){
	    const element=document.getElementById(line_events[0][1]);
	    if (line_events[0].length==3)
		element.innerHTML = line_events[0][2];
	    else
		element.style.color = '#f00';
	    if (ball_x1!=undefined){
		ball_t0 = ball_t1;
		ball_x0 = ball_x1;
		ball_y0 = ball_y1;
		ball_x1 = undefined;
	    }
	}
	for (; beat_events.length!=0&&start_time+beat_events[0][0]<now; beat_events=beat_events.slice(1)){
	    last_beat_time = beat_events[0][0];
	    cats.forEach(function(cat){
		cat[4] = (cat[4]+1)%cat[3];
	    });
	    beat_counter.innerHTML = beat_events[0][1]
	}
	if (beat_events.length!=0 && last_beat_time!=undefined){
	    const t=(now-start_time-last_beat_time)/(beat_events[0][0]-last_beat_time);
	    cats.forEach(function(cat){
		document.getElementById(cat[0]).src = cat[1]+Math.floor((cat[4]+t)*cat[2]/cat[3])+".png";
	    });
	}
	window.requestAnimationFrame(animate);
    }
    websocket.onopen = function(){
	window.setInterval(do_ntp,1000);
	do_ntp();
    };
    websocket.onmessage = function(event){
	const now=new Date().getTime();
	if (event.data.slice(0,1)=="t"){
	    timeout = 4;
	    const ntp_t1=parseInt(event.data.slice(1));
	    ntp_offset = (now+ntp_t0)/2-ntp_t1+DELAY;
	}
	if (event.data.slice(0,1)=="k" && ntp_offset!=undefined){
	    const json=JSON.parse(event.data.slice(1));
	    if (json.what=="karaoke"){
		nname.innerHTML = json.name;
		title.innerHTML = json.name;
		karaoke = json.karaoke;
	    }
	    if (json.what=="start"){
		start_time = json.time+ntp_offset;
		repeat_time = 0;
		karaoke_index = 0;
		next_line_start = 0;
		which_line = 0;
		cats.forEach(function(cat){
		    cat[4]=0;
		});
		last_cat = 0;
		last_fatcat = 0;
		last_beat_time = undefined;
		ball_x0 = undefined;
		ball_x1 = undefined;
		line_events = [];
		beat_events = [];
		lines[0].innerHTML = "";
		lines[1].innerHTML = "";
		window.requestAnimationFrame(animate);
	    }
	    if (json.what=="stop")
		start_time = undefined;
	}
    }
</script>
</html>
