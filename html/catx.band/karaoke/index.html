<!doctype html> 
<html>
<head>
<meta charset=UTF-8>
<title id=title>Karaoke</title>
</head>
<style>
    .tooltip{
	position:relative;
	display:inline-block;
    }
    .tooltip .tooltiptext{
	position:absolute;
	visibility:hidden;
	width:50vw;
	background-color:#000;
	color:#0f0;
	z-index:1;
	top:125%;
	left:75%;
    }
    .tooltip:hover .tooltiptext{
	visibility:visible;
    }
</style>
<body>
<script src=websocketstuff.js?version=1></script>
<script src=settings.js?version=1></script>
<script src=cats.js?version=1></script>
<script src=background.js?version=1></script>
<script src=tones.js?version=1></script>
<script src=beatcounter.js?version=1></script>
<script src=snakes.js?version=1></script>
<script src=球球.js?version=1></script>
<span id=bigSettings style=position:absolute;width:98%;>
    <span style=position:absolute;left:0;width:29%;display:inline-block;>
	<button type=submit style=font-size:20px; onclick=start(0);>Start 球球!</button>
	<button type=submit style=font-size:20px; onclick=start(1);>Start Snakes!</button>
	<br>
	<span id=settingsInputs></span>
	<div class=tooltip>
	    <button type=button style=font-size:16px; onclick=settings.resetToDefault();>Reset</button>
	    <span class=tooltiptext>Click Reset to reset these settings to default.</span>
	</div>
	<br>
	Bookmark this <a id=settingsBookmarkLink>link</a> to save settings.
    </span>
    <span style=position:absolute;left:29%;width:69%;display:inline-block;>
	Private Chat With Aarin Robo:
	<br>
	<div id=chatDiv style=width:100%;height:90vh;overflow-y:scroll;background-color:#ccc;></div>
	<form id=chatForm style=width:100%;display:table;>
	    <label for=chatInput style=display:table-cell;width:0;>Chat:</label>
	    <input id=chatInput style=display:table-cell;width:100%;font-size:15px; type=text>
	</form>
    </span>
</span>
<span id=bigSpan style=display:none;position:absolute;left:0;top:0;width:100vw;height:100vh;overflow:hidden;>
    <span id=websocketControls style=visibility:hidden;>
	<img style=position:absolute;left:0;top:0;width:5vw;z-index:9; onclick=websocketStuff.sendChat("stop"); src=../stop.svg></a>
	<img style=position:absolute;left:6vw;top:0;width:5vw;z-index:9; onclick=websocketStuff.sendChat("play"); src=../play.svg></a>
    </span>
    <img style=position:absolute;right:0;top:0;width:5vw;z-index:9;color:#0f0; src=../settings.svg onclick=backToSettings();>
    <div id=cat_div style=position:absolute;left:0;top:10vh;width:100vw;></div>
    <div style=position:absolute;top:0;left:0;width:100vw;height:10vh;text-align:center;>
	<span id=name style=font-size:3vw;white-space:nowrap;color:#0f0;background-color:#000;></span>
    </div>
    <div style=position:absolute;top:10vh;left:0;width:100vw;text-align:center;>
	<span id=beat_span style=font-family:monospace;font-size:8vh;color:#000;background-color:#0f0;></span>
    </div>
    <div id=bg_div style=position:absolute;left:0;top:35vh;width:100vw;height:65vh;z-index:-9;text-align:center;></div>
</span>
<script>
    let audioContext;
    let settingsVisible=true;
    const settings=new Settings(document.getElementById("settingsBookmarkLink"),document.getElementById("settingsInputs"));
    const chatDiv=document.getElementById("chatDiv");
    const chatForm=document.getElementById("chatForm");
    const cats=new Cats(document.getElementById("cat_div"));
    const background=new Background(document.getElementById("bg_div"));
    const tones=new Tones(document.getElementById("bigSpan"));
    const beatCounter=new BeatCounter(cats,document.getElementById("beat_span"));
    const qiuqius=new 球球(document.getElementById("bigSpan"));
    const snakes=new Snakes(document.getElementById("bigSpan"));
    let startTime;
    const websocketStuff=new class extends WebsocketStuff{
	onopen(){
	    super.onopen();
	    document.getElementById("websocketControls").style.visibility = "inherit";
	    websocketStuff.sendChat("help");
	}
	onmessage(event){
	    super.onmessage(event);
	    if (event.data.slice(0,4)=="chat"){
		let c=event.data.slice(4);
		chatDiv.innerHTML += c+"<br>";
		chatDiv.scrollTop = chatDiv.scrollHeight;
	    }
	    if (event.data.slice(0,1)=="k" && this.ntp_offset!=undefined){
		const json=JSON.parse(event.data.slice(1));
		if ("name" in json){
		    document.getElementById("name").innerHTML = json.name;
		    document.getElementById("title").innerHTML = json.name;
		}
		if ("karaoke" in json){
		    startTime = json.start_time+this.ntp_offset+settings.delay;
		    const repeat="repeat" in json?json.repeat:0;
		    cats.reset();
		    background.reset(startTime,repeat,json.length);
		    tones.reset(startTime,repeat,json.length);
		    beatCounter.reset(startTime,repeat,json.length);
		    snakes.reset(startTime,repeat,json.length);
		    qiuqius.reset(startTime,repeat);
		    const noteOn=new Map();
		    const noteOff=new Map();
		    for (const e of json.karaoke){
			if ("k" in e)
			    for (let k of e.k.split("|")){
				if (k.slice(0,6)=="!beat="){
				    beatCounter.addEvent(e.t,k.slice(6));
				    snakes.addBeatEvent(e.t,k.slice(6));
				}else if (k.slice(0,4)=="!bg=")
				    background.addEvent(e.t,k.slice(4));
				else{
				    qiuqius.addEvent(e.t,k);
				    snakes.addLyricEvent(e.t,k);
				}
			    }
			if ("key" in e)
			    snakes.addKeysignatureEvent(e);
			if ("on" in e && (!noteOff.has(e.on) || !noteOff.get(e.on).delete(e.t))){
			    if (!noteOn.has(e.on))
				noteOn.set(e.on,new Set());
			    noteOn.get(e.on).add(e.t);
			}
			if ("off" in e && (!noteOn.has(e.off) || !noteOn.get(e.off).delete(e.t))){
			    if (!noteOff.has(e.off))
				noteOff.set(e.off,new Set());
			    noteOff.get(e.off).add(e.t);
			}
		    }
		    for (const note of noteOff.keys())
			noteOff.set(note,Array.from(noteOff.get(note)).sort((x,y)=>x-y));
		    const allNotes=[];
		    for (const note of noteOn.keys())
			for (const time of noteOn.get(note)){
			    let end;
			    while (noteOff.has(note) && (end=noteOff.get(note).shift())<time);
			    if (end!=undefined)
				allNotes.push({t:time,duration:end-time,note:note});
			}
		    allNotes.sort((x,y)=>x.t-y.t);
		    for (const e of allNotes){
			tones.addEvent(e);
			snakes.addToneEvent(e);
		    }
		    snakes.doneAddingEvents();
		    requestAnimationFrame(animate);
		}
		if ("stop" in json)
		    startTime = undefined;
	    }
	}
    }();
    chatForm.onsubmit = function(event){
	const chatInput=document.getElementById("chatInput");
	chatDiv.innerHTML += "<font color=pink><b>You</b></font> "+chatInput.value+"<br>";
	chatDiv.scrollTop = chatDiv.scrollHeight;
	websocketStuff.sendChat(chatInput.value);
	chatInput.value = "";
	event.preventDefault();
    };
    function animate(){
	if (startTime==undefined)
	    return;
	const now=new Date().getTime();
	snakes.animate(now);
	qiuqius.animate(now);
	background.animate(now);
	tones.animate(now);
	beatCounter.animate(now);
	requestAnimationFrame(animate);
    }
    function backToSettings(){
	settingsVisible = true;
	document.getElementById("bigSettings").style.display = "block";
	document.getElementById("bigSpan").style.display = "none";
    }
    function start(snakeMode){
	settingsVisible = false;
	if (audioContext==undefined)
	    audioContext = new (window.AudioContext||window.webkitAudioContext)();
	document.getElementById("bigSettings").style.display = "none";
	document.getElementById("bigSpan").style.display = "block";
	tones.setEnabled(true);
	snakes.setEnabled(snakeMode);
	qiuqius.setEnabled(!snakeMode);
	cats.setEnabled(!snakeMode);
	background.setEnabled(!snakeMode);
    }
    websocketStuff.start();
</script>
</html>
