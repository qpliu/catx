<!doctype html> 
<html>
<head>
<meta charset=UTF-8>
<title id=title>Karaoke</title>
</head>
<body style=overflow:hidden;>
<a id=setup href=setup.html><img style=position:absolute;right:0;top:0;width:5vw;z-index:9;color:#0f0; src=../settings.svg></a>
<img id=speakerOn style=visibility:hidden;position:absolute;right:6vw;top:0;width:5vw;z-index:9; onclick=toggleSpeaker() src=../speaker.svg></a>
<img id=speakerOff style=position:absolute;right:6vw;top:0;width:5vw;z-index:9; onclick=toggleSpeaker() src=../speaker_off.svg></a>
<span id=websocketControls style=visibility:hidden;>
<img style=position:absolute;left:0;top:0;width:5vw;z-index:9; onclick=websocketStuff.sendChat("stop") src=../stop.svg></a>
<img style=position:absolute;left:6vw;top:0;width:5vw;z-index:9; onclick=websocketStuff.sendChat("play") src=../play.svg></a>
</span>
<div id=div style=position:absolute;left:0;top:10vh;width:100vw;></div>
<div style=position:absolute;top:0;left:0;width:100vw;height:10vh;text-align:center;><span id=name style=font-size:6vh;white-space:nowrap;color:#0f0;background-color:#000;></span></div>
<div style=position:absolute;top:10vh;left:0;width:100vw;height:10vh;text-align:center;><span id=beat_counter style=font-family:monospace;font-size:8vh;color:#000;background-color:#0f0;>1</span></div>
<div id=line1at style=position:absolute;top:64vh;left:5vw;width:5vw;font-size:2vw;></div>
<div id=line1 style=position:absolute;top:64vh;left:10vw;width:90vw;font-size:2vw;white-space:nowrap;></div>
<div id=line0at style=position:absolute;top:85vh;left:15vw;width:5vw;font-size:2vw;></div>
<div id=line0 style=position:absolute;top:85vh;left:20vw;width:80vw;font-size:2vw;white-space:nowrap;></div>
<div id=lineatat style=position:absolute;top:100vh;left:97.5vw;height:0;></div>
<img id=ball style=position:absolute;bottom:100vh;width:5vw;z-index:2; src=../ball.png>
<div style=position:absolute;left:0;top:35vh;width:100vw;height:65vh;z-index:-9;text-align:center;>
<span id=bgtext style=font-size:45vh;margin-top:10vh;color:#0f0;opacity:.5;display:none;></span>
<img id=bgimg style=opacity:.25;margin-left:auto;margin-right:auto;height:65vh;display:none;>
</div>
<canvas id=snakes1 style=position:absolute;top:20vh;left:0;width:100vw;height:40vh;background-color:#000;display:none;></canvas>
<div id=snakes1w style=position:absolute;bottom:40vh;left:0;width:100vw;height:5vh;font-size:1vw;white-space:nowrap;color:#0f0;background-color:#000;display:none;z-index:1;></div>
<canvas id=snakes0 style=position:absolute;top:60vh;left:0;width:100vw;height:40vh;background-color:#000;display:none;></canvas>
<div id=snakes0w style=position:absolute;bottom:0vh;left:0;width:100vw;height:5vh;font-size:1vw;white-space:nowrap;color:#0f0;background-color:#000;display:none;z-index:1;></div>
<script src=settings.js></script>
<script src=websocketstuff.js></script>
<script>
    const settings=new Settings();
    let speakerOn=0;
    const audioContext=new AudioContext();
    const CANVAS_WIDTH=1024;
    const CANVAS_HEIGHT=(settings.maxNote-settings.minNote)*10;
    const cats=[
	["../cat/cat-${frame}.png",40,8,"position:absolute;left:0;top:0;width:15vw;z-index:-1;"],
	["../cat/fatcat-${frame}.png",8,2,"position:absolute;left:82vw;top:0;width:18vw;z-index:-1;"],
	["../cat/graycat-${frame}.png",4,1,"position:absolute;left:15vw;top:0;width:15vw;z-index:-1;"],
	["../cat/spin-${frame}.png",18,2,"position:absolute;left:30vw;top:0;width:15vw;z-index:-1;"],
	["../cat/pink-${frame}.png",8,2,"position:absolute;left:55vw;top:0;width:18vw;z-index:-1;"],
	["../cat/jump-${frame}.png",8,4,"position:absolute;left:70vw;top:0;width:15vw;z-index:-1;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:-9vw;top:-5vw;width:20vw;z-index:-3;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:2vw;top:-5vw;width:20vw;z-index:-2;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:13vw;top:-5vw;width:20vw;z-index:-3;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:24vw;top:-5vw;width:20vw;z-index:-2;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:35vw;top:-5vw;width:20vw;z-index:-3;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:46vw;top:-5vw;width:20vw;z-index:-2;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:58vw;top:-5vw;width:20vw;z-index:-3;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:69vw;top:-5vw;width:20vw;z-index:-2;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:80vw;top:-5vw;width:20vw;z-index:-3;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:91vw;top:-5vw;width:20vw;z-index:-2;"],
	["../cat/wave-${frame}.jpg",15,4,"position:absolute;left:0;top:-10vw;width:34vw;z-index:-4;"],
	["../cat/wave-${frame}.jpg",15,4,"position:absolute;left:34vw;top:-10vw;width:34vw;z-index:-4;"],
	["../cat/wave-${frame}.jpg",15,4,"position:absolute;left:68vw;top:-10vw;width:34vw;z-index:-4;"],
    ];
    const toneOscillator=audioContext.createOscillator();
    const toneGain=audioContext.createGain();
    toneGain.gain.value = 0;
    toneGain.connect(audioContext.destination);
    toneOscillator.connect(toneGain);
    toneOscillator.start();
    let fft;
    let fft_data;
    let last_fft_time;
    let start_time;
    let repeat;
    const bgimg=document.getElementById("bgimg");
    document.getElementById("setup").href += settings.locationSearch;
    const bgtext=document.getElementById("bgtext");
    const ball=document.getElementById("ball");
    const beat_counter=document.getElementById("beat_counter");
    const lines=[document.getElementById("line0"),document.getElementById("line1")];
    const snakes=[document.getElementById("snakes0"),document.getElementById("snakes1")];
    const snakesw=[document.getElementById("snakes0w"),document.getElementById("snakes1w")];
    let which_line;
    let id_counter=0;
    let line_events;
    let word_element;
    let word_t0;
    let word_t1;
    let ball_events;
    let beat_index;
    let beat_repeat;
    let beat_events;
    let bg_index;
    let bg_repeat;
    let bg_events;
    let tone_index;
    let tone_repeat;
    let tone_events;
    let lyric_index;
    let lyric_repeat;
    let lyric_events;
    let next_line_start;
    let snake_time;
    let ball_x0,ball_y0,ball_t0;
    let ball_x1,ball_y1,ball_t1;
    if (settings.snakes){
	for (const i in snakes){
	    snakes[i].style.display = "block";
	    snakes[i].width = CANVAS_WIDTH;
	    snakes[i].height = CANVAS_HEIGHT;
	    snakesw[i].style.display = "block";
	}
	cats.length = 0;
    }else
	for (const cat of cats){
	    const div=document.getElementById("div");
	    l = [];
	    for (let frame=0; frame<cat[1]; frame++){
		const img=document.createElement("img");
		img.src = eval("`"+cat[0]+"`");
		img.style = cat[3];
		div.appendChild(img);
		l.push(img);
		if (frame!=0)
		    img.style.visibility = "hidden";
	    }
	    cat.push(0);
	    cat.push(l);
	    cat.push(0);
	}
    websocketStuff = new class extends WebsocketStuff{
	onopen(){
	    super.onopen();
	    document.getElementById("websocketControls").style.visibility = "visible";
	}
	onmessage(event){
	    super.onmessage(event);
	    if (event.data.slice(0,1)=="k" && this.ntp_offset!=undefined){
		const json=JSON.parse(event.data.slice(1));
		if ("name" in json){
		    document.getElementById("name").innerHTML = json.name;
		    document.getElementById("title").innerHTML = json.name;
		}
		if ("karaoke" in json){
		    start_time = json.start_time+this.ntp_offset+settings.delay;
		    last_fft_time = start_time;
		    repeat = "repeat" in json?json.repeat:0;
		    next_line_start = 0;
		    which_line = 0;
		    for (const cat of cats)
			cat[4] = 0;
		    ball_t0 = undefined;
		    ball_t1 = start_time;
		    word_element = null;
		    line_events = [];
		    lyric_repeat = 0;
		    lyric_index = 0;
		    lyric_events = [];
		    beat_index = 0;
		    beat_repeat = 0;
		    beat_events = [];
		    bg_index = 0;
		    bg_repeat = 0;
		    bg_events = [];
		    tone_index = 0;
		    tone_repeat = 0;
		    tone_events = [];
		    snake_time = 0;
		    let last_tone=undefined;
		    for (const e of json.karaoke){
			if ("k" in e)
			    for (let k of e.k.split("|")){
				if (k.slice(0,6)=="!beat=")
				    beat_events.push([e.t,k.slice(6)]);
				else if (k.slice(0,4)=="!bg=")
				    bg_events.push([e.t,k.slice(4)]);
				else
				    lyric_events.push([e.t,k]);
			    }
			if ("on" in e)
			    last_tone = e;
			if ("off" in e && last_tone!=undefined)
			    tone_events.push([last_tone.t,e.t-last_tone.t,last_tone.on+settings.transpose]);
		    }
		    ball_events = [];
		    lines[0].innerHTML = "";
		    lines[1].innerHTML = "";
		    bgimg.style.display = "none";
		    bgtext.style.display = "none";
		    window.requestAnimationFrame(settings.snakes?animateSnakes:animateBall);
		}
		if ("stop" in json)
		    start_time = undefined;
	    }
	}
    }();
    function animateBeatEvents(now){
	while (beat_index<beat_events.length){
	    const e=beat_events[beat_index];
	    const t=start_time+e[0]+beat_repeat;
	    if (t>now){
		if (beat_index!=0){
		    const x=1-(t-now)/(beat_events[beat_index][0]-beat_events[beat_index-1][0]);
		    for (const cat of cats){
			cat[5][cat[6]].style.visibility = "hidden";
			cat[6] = Math.floor((cat[4]+x)*cat[1]/cat[2])%cat[1];
			cat[5][cat[6]].style.visibility = "visible";
		    }
		}
		break;
	    }
	    for (const cat of cats)
		cat[4] = (cat[4]+1)%cat[2];
	    beat_counter.innerHTML = beat_events[beat_index][1]
	    if (repeat && beat_index==beat_events.length-1){
		beat_repeat = Math.ceil((now-start_time-e[0])/repeat)*repeat;
		beat_index = 0;
	    }else
		beat_index++;
	}
    }
    function animateBgEvents(now){
	while (bg_index<bg_events.length){
	    const e=bg_events[bg_index];
	    const t=start_time+e[0]+bg_repeat;
	    if (t>now)
		break;
	    bgimg.style.display = "none";
	    bgtext.style.display = "none";
	    bgimg.src = "";
	    bgtext.innerHTML = "";
	    if (e[1].slice(0,4)=="img="){
		bgimg.src = e[1].slice(4);
		bgimg.style.display = "block";
	    }else{
		bgtext.innerHTML = e[1];
		bgtext.style.display = "block";
	    }
	    if (repeat && bg_index==bg_events.length-1){
		bg_repeat = Math.ceil((now-start_time-e[0])/repeat)*repeat;
		bg_index = 0;
	    }else
		bg_index++;
	}
    }
    function gotAudio(e){
	const now=new Date().getTime();
	console.log(e.inputBuffer.length);
    }
    function animateToneEvents(now){
	while (tone_index<tone_events.length){
	    const e=tone_events[tone_index];
	    const t=start_time+e[0]+tone_repeat;
	    if (t>now)
		break;
	    if (speakerOn && t+e[1]>now){
		toneOscillator.frequency.value = Math.exp((e[2]-69)/12*Math.log(2))*440;
		toneGain.gain.setValueAtTime(.001,audioContext.currentTime);
		toneGain.gain.exponentialRampToValueAtTime(1,audioContext.currentTime+Math.min(e[1]/2500,.05));
		toneGain.gain.setValueAtTime(1,audioContext.currentTime+e[1]/1000-Math.min(e[1]/2500,.05));
		toneGain.gain.exponentialRampToValueAtTime(.001,audioContext.currentTime+e[1]/1000);
	    }
	    if (repeat && tone_index==tone_events.length-1){
		tone_repeat = Math.ceil((now-start_time-e[0])/repeat)*repeat;
		tone_index = 0;
	    }else
		tone_index++;
	}
    }
    function animateSnakes(time){
	if (start_time==undefined)
	    return;
	const now=new Date().getTime();
	if (fft!=undefined){
	    let canvas;
	    let canvas_start;
	    if (now<start_time+snake_time-settings.timePerSnake){
		canvas = snakes[which_line^1];
		canvas_start = start_time+snake_time-2*settings.timePerSnake;
	    }else{
		canvas = snakes[which_line];
		canvas_start = start_time+snake_time-settings.timePerSnake;
	    }
	    const context=canvas.getContext("2d");
	    context.globalCompositeOperation = "lighter";
	    const x0=Math.floor(Math.max((last_fft_time-canvas_start)*CANVAS_WIDTH/settings.timePerSnake,0));
	    const x1=Math.floor((now-canvas_start)*CANVAS_WIDTH/settings.timePerSnake);
	    last_fft_time = now;
	    context.globalCompositeOperation = "difference";
	    context.fillStyle = "#404040";
	    context.fillRect(x0,0,x1-x0,CANVAS_HEIGHT);
	    context.globalCompositeOperation = "lighten";
	    fft.getByteFrequencyData(fft_data);
	    const i0=Math.floor(Math.exp((settings.minNote-69)/12*Math.log(2))*440*settings.fftSize/audioContext.sampleRate);
	    const i1=Math.floor(Math.exp((settings.maxNote-69)/12*Math.log(2))*440*settings.fftSize/audioContext.sampleRate);
	    for (let i=i0; i<i1; i++){
		const n0=69+Math.log(i*audioContext.sampleRate/settings.fftSize/440)/Math.log(2)*12;
		const n1=69+Math.log((i+1)*audioContext.sampleRate/settings.fftSize/440)/Math.log(2)*12;
		const y0=Math.floor((settings.maxNote-n0)/(settings.maxNote-settings.minNote)*CANVAS_HEIGHT);
		const y1=Math.floor((settings.maxNote-n1)/(settings.maxNote-settings.minNote)*CANVAS_HEIGHT);
		let d=fft_data[i];
		for (let j=2; i*j<fft_data.length&&j<=settings.harmonics; j++)
		    d = Math.min(d,fft_data[i*j]);
		for (let j=2; j<=settings.subharmonics; j++){
		    let f=i/j;
		    let ff=Math.floor(f);
		    f -= ff;
		    d -= fft_data[ff]*(1-f)+fft_data[ff+1]*f;
		}
		d = Math.max(0,d);
		context.fillStyle = "rgb("+d+","+d+","+0+")";
		context.fillRect(x0,y0,x1-x0,y1-y0);
	    }
	}
	while (next_line_start<now){
	    snake_time += Math.max(Math.floor((now-start_time-snake_time)/(settings.timePerSnake*2)),0)*settings.timePerSnake*2;
	    which_line ^= 1;
	    sb = ""
	    const canvas=snakes[which_line];
	    const context=canvas.getContext("2d");
	    context.globalCompositeOperation = "source-over";
	    context.fillStyle = "#404040";
	    context.fillRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);
	    for (const e of lyric_events){
		const r0=repeat?Math.ceil((snake_time-settings.timePerSnake-e[0])/repeat):0;
		const r1=repeat?Math.ceil((snake_time+settings.timePerSnake-e[0])/repeat):1;
		for (let r=r0; r<r1; r++){
		    const t=e[0]+repeat*r;
		    if (t>snake_time-settings.timePerSnake && t<snake_time+settings.timePerSnake){
			let k=e[1];
			if (k.slice(0,1)==">")
			    k = k.slice(1);
			if (k=="@" || k=="@@")
			    continue;
			if (k.slice(0,1)=="-")
			    k = k.slice(1);
			if (k.length!=0)
			    sb += "<span style=position:absolute;left:"+(t-snake_time)*100/settings.timePerSnake+"vw;bottom:0>"+k+"</span>"
		    }
		}
	    }
	    for (const e of beat_events){
		const r0=repeat?Math.ceil((snake_time-settings.timePerSnake-e[0])/repeat):0;
		const r1=repeat?Math.ceil((snake_time+settings.timePerSnake-e[0])/repeat):1;
		for (let r=r0; r<r1; r++){
		    const t=e[0]+repeat*r;
		    if (t>snake_time-settings.timePerSnake && t<snake_time+settings.timePerSnake){
			let k=e[1];
			if (k.slice(-2)==':1' || k.slice(-2)=='=1')
			    context.fillStyle = "#ff4040";
			else
			    context.fillStyle = "#4040ff";
			const x0=(t-snake_time)/settings.timePerSnake*CANVAS_WIDTH;
			context.fillRect(x0,0,1,CANVAS_HEIGHT);
		    }
		}
	    }
	    context.fillStyle = "#ff40ff";
	    for (const e of tone_events){
		const y0=(settings.maxNote-e[2]-.5)/(settings.maxNote-settings.minNote)*CANVAS_HEIGHT;
		const y1=(settings.maxNote-e[2]+.5)/(settings.maxNote-settings.minNote)*CANVAS_HEIGHT;
		const r0=repeat?Math.ceil((snake_time-(e[0]+e[1]))/repeat):0;
		const r1=repeat?Math.ceil((snake_time-e[0])/repeat):0;
		for (let r=r0; r<=r1; r++){
		    const x0=Math.max((e[0]+repeat*r-snake_time)/settings.timePerSnake,0)*CANVAS_WIDTH;
		    const x1=Math.min(((e[0]+e[1])+repeat*r-snake_time)/settings.timePerSnake,1)*CANVAS_WIDTH;
		    if (x1>x0)
			context.fillRect(x0,y0,x1-x0,y1-y0);
		}
	    }
	    snakesw[which_line].innerHTML = sb;
	    next_line_start = start_time+snake_time+settings.timePerSnake/2;
	    snake_time += settings.timePerSnake;
	}
	animateToneEvents(now);
	animateBeatEvents(now);
	window.requestAnimationFrame(animateSnakes);
    }
    function animateBall(time){
	if (start_time==undefined)
	    return;
	const now=new Date().getTime();
	while (next_line_start<now && lyric_index<lyric_events.length){
	    which_line ^= 1;
	    let this_line_start;
	    let this_line_end;
	    sb = ""
	    while (lyric_index<lyric_events.length){
		const e=lyric_events[lyric_index];
		const t=start_time+e[0]+lyric_repeat;
		let k=e[1];
		if (k.slice(0,1)==">"){
		    if (this_line_start!=undefined)
			break;
		    k = k.slice(1);
		}
		if (k=="@@"){
		    ball_events.push([t,"lineatat"]);
		    k = "-";
		}else if (k=="@"){
		    ball_events.push([t,which_line?"line1at":"line0at"]);
		    k = "-";
		}
		if (k.slice(0,1)=="-")
		    k = k.slice(1);
		else if (sb.length!=0)
		    sb += "&nbsp;";
		sb += "<span style=position:relative;>";
		sb += "<span style=color:#000;>"+k+"</span>";
		sb += "<span id=id"+id_counter+" style=overflow:hidden;position:absolute;left:0;width:0;z-index:1;color:#f00;>"+k+"</span>";
		sb += "</span>";
		if (k.length!=0){
		    this_line_end = t;
		    if (this_line_start==undefined)
			this_line_start = t;
		    ball_events.push([t,"id"+id_counter]);
		}
		line_events.push([t,"id"+id_counter]);
		id_counter++;
		if (repeat && lyric_index==lyric_events.length-1){
		    lyric_repeat = Math.max(Math.ceil((now-start_time-e[0])/repeat)*repeat,lyric_repeat+repeat);
		    lyric_index = 0;
		    if (this_line_start!=undefined)
			break;
		}else
		    lyric_index++;
	    }
	    lines[which_line].innerHTML = sb;
	    if (this_line_start==undefined)
		next_line_start = now;
	    else
		next_line_start = (2*this_line_start+this_line_end)/3;
	}
	for (; line_events.length!=0&&line_events[0][0]<now; line_events=line_events.slice(1)){
	    if (word_element!=null)
		word_element.style.overflow = "visible";
	    word_element = document.getElementById(line_events[0][1]);
	    if (word_element!=null){
		word_t0 = line_events[0][0];
		word_t1 = line_events.length>1?line_events[1][0]:now;
	    }
	}
	if (word_element!=null)
	    word_element.style.width = (now-word_t0)/(word_t1-word_t0)*100+"%";
	for (; line_events.length!=0&&line_events[0][0]<now; line_events=line_events.slice(1)){
	    let element=document.getElementById(line_events[0][1]);
	    if (element==null)
		continue;
	    element.style.color = '#f00';
	}
	for (; ball_t1<now&&ball_events.length!=0; ball_events=ball_events.slice(1)){
	    let element=document.getElementById(ball_events[0][1]);
	    if (element==null)
		continue;
	    const rect=element.getBoundingClientRect();
	    ball_t0 = ball_t1;
	    ball_x0 = ball_x1;
	    ball_y0 = ball_y1;
	    ball_t1 = ball_events[0][0];
	    ball_x1 = rect.left;
	    ball_y1 = rect.top;
	}
	if (ball_t0!=undefined){
	    const tt=ball_t1-ball_t0;
	    const t=Math.min((now-ball_t0)/tt,1);
	    const r=ball.getBoundingClientRect();
	    ball.style.left = (ball_x0+t*(ball_x1-ball_x0)+(r.left-r.right)/2)+"px";
	    const bounce_height=2*(r.bottom-r.top);
	    ball.style.top = (ball_y0+t*(ball_y1-ball_y0)-r.bottom+r.top-(1-4*(t-.5)*(t-.5))*bounce_height*Math.min(tt/2000,1))+"px";
	}
	animateBgEvents(now);
	animateToneEvents(now);
	animateBeatEvents(now);
	window.requestAnimationFrame(animateBall);
    }
    async function gotUserMedia(stream){
	const microphone=audioContext.createMediaStreamSource(stream);
	fft = audioContext.createAnalyser();
	fft.smoothingTimeConstant = 0;
	fft.fftSize = settings.fftSize;
	fft.maxDecibels = settings.maxDecibels;
	fft.minDecibels = settings.minDecibels;
	microphone.connect(fft);
	fft_data = new Uint8Array(fft.frequencyBinCount);
    }
    function toggleSpeaker(){
	speakerOn ^= 1;
	if (!speakerOn)
	    toneGain.gain.setValueAtTime(0,audioContext.currentTime);
	document.getElementById("speakerOn").style.visibility = speakerOn?"visible":"hidden";
	document.getElementById("speakerOff").style.visibility = speakerOn?"hidden":"visible";
    }
    if (settings.snakes)
	navigator.mediaDevices.getUserMedia({audio:true}).then(gotUserMedia).catch(function(err){alert(err);});
    websocketStuff.start();
</script>
</html>
