<!doctype html> 
<html>
<head>
<meta charset=UTF-8>
<title id=title>Karaoke</title>
</head>
<div style=text-align:center;><span id=name style=font-size:300%;color:#0f0;background-color:#000;>Start playing a song with Aarin Robo to sing karaoke!</span></div>
<div style=text-align:center;><span id=beat_counter style=font-size:400%;color:#000;background-color:#0f0;>1</span></div>
<br>
<br>
<br>
<span id=line1 style=font-size:150%;></span>
<br>
<br>
<br>
<span id=line2 style=margin-left:96px;font-size:150%;></span>
<script>
    var DELAY=200;
    var HZ=30;
    var websocket=new WebSocket("wss://catx.band/karaoke_websocket");
    var ntp_t0;
    var ntp_offset;
    var karaoke;
    var index;
    var start_time;
    var title=document.getElementById("title");
    var beat_counter=document.getElementById("beat_counter");
    var nname=document.getElementById("name");
    var lines=[document.getElementById("line2"),document.getElementById("line1")];
    var line_index;
    var timeout=4;
    var send_ntp_count=0;
    websocket.onopen = function(){
	ntp_t0 = new Date().getTime();
	websocket.send("");
    };
    websocket.onmessage = function(event){
	var now=new Date().getTime();
	if (event.data.slice(0,1)=="t"){
	    timeout = 4;
	    var ntp_t1=parseInt(event.data.slice(1));
	    ntp_offset = (now+ntp_t0)/2-ntp_t1+DELAY;
	    console.log("ntp_offset="+ntp_offset);
	}
	if (event.data.slice(0,1)=="k"){
	    var json=JSON.parse(event.data.slice(1));
	    if (json.what=="karaoke"){
		nname.innerHTML = json.name;
		title.innerHTML = json.name;
		karaoke = json.karaoke;
	    }
	    if (json.what=="start"){
		start_time = json.time+ntp_offset;
		index = 0;
		line_index = 0;
		lines[0].innerHTML = "";
		lines[1].innerHTML = "";
		console.log("Got start "+start_time+" now="+now);
	    }
	    if (json.what=="stop")
		start_time = undefined;
	}
    }
    window.setInterval(function(){
	if (start_time!=undefined){
	    var now=new Date().getTime();
	    while (index<karaoke.length){
		if (start_time+karaoke[index].t>now)
		    break;
		k = karaoke[index].k;
		if (k.slice(0,1)=="^")
		    beat_counter.innerHTML = k.slice(1);
		else{
		    if (k.slice(0,1)==">"){
			k = k.slice(1);
			line_index ^= 1;
			lines[line_index].innerHTML = "";
		    }
		    if (k.slice(0,1)=="-")
			k = k.slice(1);
		    else
			lines[line_index].innerHTML += " ";
		    lines[line_index].innerHTML += k;
		}
		index++;
	    }
	}
	if (++send_ntp_count==HZ){
	    if (--timeout<0)
		location.reload();
	    websocket.send("");
	    send_ntp_count = 0;
	}
    },1000/HZ);
</script>
</html>
