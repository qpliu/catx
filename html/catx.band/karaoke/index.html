<!doctype html> 
<html>
<head>
<meta charset=UTF-8>
<title id=title>Karaoke</title>
</head>
<body style=overflow:hidden;>
<a id=setup href=setup.html><img style=position:absolute;right:0;top:0;width:5vw;z-index:9;color:#0f0; src=../settings.svg></a>
<span id=span></span>
<span id=websocketControls style=visibility:hidden;>
<img style=position:absolute;left:0;top:0;width:5vw;z-index:9; onclick=websocketStuff.sendChat("stop") src=../stop.svg></a>
<img style=position:absolute;left:6vw;top:0;width:5vw;z-index:9; onclick=websocketStuff.sendChat("play") src=../play.svg></a>
</span>
<div id=cat_div style=position:absolute;left:0;top:10vh;width:100vw;></div>
<div style=position:absolute;top:0;left:0;width:100vw;height:10vh;text-align:center;><span id=name style=font-size:6vh;white-space:nowrap;color:#0f0;background-color:#000;></span></div>
<div id=beat_div style=position:absolute;top:10vh;left:0;width:100vw;height:10vh;text-align:center;></div>
<div id=bg_div style=position:absolute;left:0;top:35vh;width:100vw;height:65vh;z-index:-9;text-align:center;></div>
<script src=settings.js></script>
<script src=websocketstuff.js></script>
<script src=cats.js></script>
<script src=background.js></script>
<script src=tones.js></script>
<script src=beatcounter.js></script>
<script src=snakes.js></script>
<script src=球球.js></script>
<script>
    const audioContext=new AudioContext();
    const settings=new Settings();
    document.getElementById("setup").href += settings.locationSearch;
    const cats=new Cats();
    const background=new Background();
    const tones=new Tones(audioContext,document.getElementById("span"));
    const beatCounter=new BeatCounter(cats,document.getElementById("beat_div"));
    const qiuqius=new 球球();
    const snakes=new Snakes(audioContext);
    let startTime;
    if (settings.snakes)
	snakes.enable(document.getElementById("span"));
    else{
	qiuqius.enable(document.getElementById("span"));
	cats.enable(document.getElementById("cat_div"));
	background.enable(document.getElementById("bg_div"));
    }
    websocketStuff = new class extends WebsocketStuff{
	onopen(){
	    super.onopen();
	    document.getElementById("websocketControls").style.visibility = "visible";
	}
	onmessage(event){
	    super.onmessage(event);
	    if (event.data.slice(0,1)=="k" && this.ntp_offset!=undefined){
		const json=JSON.parse(event.data.slice(1));
		if ("name" in json){
		    document.getElementById("name").innerHTML = json.name;
		    document.getElementById("title").innerHTML = json.name;
		}
		if ("karaoke" in json){
		    startTime = json.start_time+this.ntp_offset+settings.delay;
		    const repeat="repeat" in json?json.repeat:0;
		    cats.reset();
		    background.reset(startTime,repeat);
		    tones.reset(startTime,repeat);
		    beatCounter.reset(startTime,repeat);
		    snakes.reset(startTime,repeat);
		    qiuqius.reset(startTime,repeat);
		    let last_tone=undefined;
		    for (const e of json.karaoke){
			if ("k" in e)
			    for (let k of e.k.split("|")){
				if (k.slice(0,6)=="!beat="){
				    beatCounter.addEvent(e.t,k.slice(6));
				    snakes.addBeatEvent(e.t,k.slice(6));
				}else if (k.slice(0,4)=="!bg=")
				    background.addEvent(e.t,k.slice(4));
				else{
				    qiuqius.addEvent(e.t,k);
				    snakes.addLyricEvent(e.t,k);
				}
			    }
			if ("on" in e)
			    last_tone = e;
			if ("off" in e && last_tone!=undefined){
			    tones.addEvent(last_tone.t,e.t-last_tone.t,last_tone.on+settings.transpose);
			    snakes.addToneEvent(last_tone.t,e.t-last_tone.t,last_tone.on+settings.transpose);
			}
		    }
		    window.requestAnimationFrame(animate);
		}
		if ("stop" in json)
		    startTime = undefined;
	    }
	}
    }();
    function animate(time){
	if (startTime==undefined)
	    return;
	const now=new Date().getTime();
	snakes.animate(now);
	qiuqius.animate(now);
	background.animate(now);
	tones.animate(now);
	beatCounter.animate(now);
	window.requestAnimationFrame(animate);
    }
    websocketStuff.start();
</script>
</html>
