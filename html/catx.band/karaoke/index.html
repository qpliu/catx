<!doctype html> 
<html>
<head>
<meta charset=UTF-8>
<title id=title>Karaoke</title>
</head>
<body style=overflow:hidden>
<div id=div style=position:absolute;left:0;top:10vh;width:100vw;></div>
<div style=position:absolute;top:0;left:0;width:100vw;height:10vh;text-align:center;><span id=name style=font-size:6vh;white-space:nowrap;color:#0f0;background-color:#000;></span></div>
<div style=position:absolute;top:10vh;left:0;width:100vw;height:10vh;text-align:center;><span id=beat_counter style=font-family:monospace;font-size:8vh;color:#000;background-color:#0f0;>1</span></div>
<div style=position:absolute;top:64vh;left:0;width:10vw;height:2vw;text-align:center;><span id=line1at style=position:absolute;font-size:2vw;color:#000;background-color:#0f0;></span></div>
<div style=position:absolute;top:64vh;left:10vw;width:90vw;height:2vw;><span id=line1 style=font-size:2vw;white-space:nowrap></span></div>
<div style=position:absolute;top:85vh;left:10vw;width:10vw;height:2vw;text-align:center;><span id=line0at style=position:absolute;font-size:2vw;color:#000;background-color:#0f0;></span></div>
<div style=position:absolute;top:85vh;left:20vw;width:80vw;height:2vw;><span id=line0 style=font-size:2vw;white-space:nowrap></span></div>
<div id=lineatat style=position:absolute;top:110vh;left:110vw;></div>
<img style=position:absolute;bottom:100vh;width:5vw id=ball src=../ball.png>
<script>
    const DELAY=200;
    const cats=[
	["../cat/cat-${frame}.png",40,8,"position:absolute;left:0;top:0;width:15vw;z-index:-1;"],
	["../cat/fatcat-${frame}.png",8,2,"position:absolute;left:82vw;top:0;width:18vw;z-index:-1;"],
	["../cat/graycat-${frame}.png",4,1,"position:absolute;left:15vw;top:0;width:15vw;z-index:-1;"],
	["../cat/spin-${frame}.png",18,2,"position:absolute;left:30vw;top:0;width:15vw;z-index:-1;"],
	["../cat/pink-${frame}.png",8,2,"position:absolute;left:55vw;top:0;width:18vw;z-index:-1;"],
	["../cat/jump-${frame}.png",8,4,"position:absolute;left:70vw;top:0;width:15vw;z-index:-1;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:-9vw;top:-5vw;width:20vw;z-index:-3;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:2vw;top:-5vw;width:20vw;z-index:-2;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:13vw;top:-5vw;width:20vw;z-index:-3;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:24vw;top:-5vw;width:20vw;z-index:-2;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:35vw;top:-5vw;width:20vw;z-index:-3;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:46vw;top:-5vw;width:20vw;z-index:-2;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:58vw;top:-5vw;width:20vw;z-index:-3;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:69vw;top:-5vw;width:20vw;z-index:-2;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:80vw;top:-5vw;width:20vw;z-index:-3;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:91vw;top:-5vw;width:20vw;z-index:-2;"],
	["../cat/wave-${frame}.jpg",15,4,"position:absolute;left:0;top:-10vw;width:34vw;z-index:-4;"],
	["../cat/wave-${frame}.jpg",15,4,"position:absolute;left:34vw;top:-10vw;width:34vw;z-index:-4;"],
	["../cat/wave-${frame}.jpg",15,4,"position:absolute;left:68vw;top:-10vw;width:34vw;z-index:-4;"],
    ];
    const websocket=new WebSocket("wss://catx.band/karaoke_websocket");
    let last_beat_time;
    let ntp_t0;
    let ntp_offset;
    let karaoke;
    let karaoke_index;
    let start_time;
    let repeat_time;
    const ball=document.getElementById("ball");
    const beat_counter=document.getElementById("beat_counter");
    const lines=[document.getElementById("line0"),document.getElementById("line1")];
    let which_line;
    let timeout=4;
    let id_counter=0;
    let line_events;
    let beat_events;
    let next_line_start;
    let ball_x0,ball_y0,ball_t0;
    cats.forEach(function(cat){
	const div=document.getElementById("div");
	l = [];
	for (let frame=0; frame<cat[1]; frame++){
	    const img=document.createElement("img");
	    img.src = eval("`"+cat[0]+"`");
	    img.style = cat[3];
	    div.appendChild(img);
	    l.push(img);
	    if (frame!=0)
		img.style.visibility = "hidden";
	}
	cat.push(0);
	cat.push(l);
	cat.push(0);
    });
    function do_ntp(){
	if (--timeout<0)
	    location.reload();
	ntp_t0 = new Date().getTime();
	websocket.send("ntp");
    }
    function animate(time){
	if (start_time==undefined)
	    return;
	const now=new Date().getTime();
	while (next_line_start<now && karaoke_index<karaoke.length){
	    which_line ^= 1;
	    let this_line_start;
	    let this_line_end;
	    sb = ""
	    for (; karaoke_index<karaoke.length; karaoke_index++){
		if ("repeat" in karaoke[karaoke_index]){
		    repeat_time += karaoke[karaoke_index].repeat;
		    karaoke_index = 0;
		    break;
		}
		let k=karaoke[karaoke_index].k;
		const t=karaoke[karaoke_index].t+repeat_time;
		if (k.slice(0,1)=="^")
		    beat_events.push([t,k.slice(1)]);
		else{
		    if (sb.length==0)
			this_line_start = t;
		    if (k.slice(0,1)==">"){
			if (sb.length!=0)
			    break;
			k = k.slice(1);
		    }
		    this_line_end = t;
		    if (k=="@@")
			line_events.push([t,"lineatat"]);
		    else if (k.slice(0,1)=="@"){
			if (which_line==0)
			    line_events.push([t,"line0at",k.slice(1)]);
			else
			    line_events.push([t,"line1at",k.slice(1)]);
		    }else{
			if (k.slice(0,1)=="-")
			    k = k.slice(1);
			else
			    k = " "+k;
			sb += "<span id=id"+id_counter+" style=color:#000;>"+k+"</span>";
			line_events.push([t,"id"+id_counter]);
			id_counter++;
		    }
		}
	    }
	    lines[which_line].innerHTML = sb;
	    next_line_start = start_time+(2*this_line_start+this_line_end)/3;
	}
	for (; line_events.length!=0&&start_time+line_events[0][0]<now; line_events=line_events.slice(1)){
	    let element=document.getElementById(line_events[0][1]);
	    if (element==null)
		continue;
	    if (line_events[0].length==3){
		element.innerHTML = line_events[0][2];
		element = element.parentElement;
	    }else
		element.style.color = '#f00';
	    const rect=element.getBoundingClientRect();
	    ball_t0 = start_time+line_events[0][0];
	    ball_x0 = (rect.left+rect.right)/2;
	    ball_y0 = rect.top;
	}
	for (; beat_events.length!=0&&start_time+beat_events[0][0]<now; beat_events=beat_events.slice(1)){
	    last_beat_time = beat_events[0][0];
	    cats.forEach(function(cat){
		cat[4] = (cat[4]+1)%cat[2];
	    });
	    beat_counter.innerHTML = beat_events[0][1]
	}
	if (line_events.length!=0 && ball_x0!=undefined){
	    let element=document.getElementById(line_events[0][1]);
	    if (element!=null){
		if (line_events[0].length==3)
		    element = element.parentElement;
		const rect=element.getBoundingClientRect();
		const ball_t1=start_time+line_events[0][0];
		const ball_x1=(rect.left+rect.right)/2;
		const ball_y1=rect.top;
		let tt=ball_t1-ball_t0;
		const t=(now-ball_t0)/tt;
		const r=ball.getBoundingClientRect();
		ball.style.left = (ball_x0+t*(ball_x1-ball_x0)+(r.left-r.right)/2)+"px";
		if (tt>2000)
		    tt = 2000;
		const bounce_height=2*(r.bottom-r.top);
		ball.style.top = (ball_y0+t*(ball_y1-ball_y0)-r.bottom+r.top-(1-4*(t-.5)*(t-.5))*bounce_height*tt/2000)+"px";
	    }
	}
	if (beat_events.length!=0 && last_beat_time!=undefined){
	    const t=(now-start_time-last_beat_time)/(beat_events[0][0]-last_beat_time);
	    cats.forEach(function(cat){
		cat[5][cat[6]].style.visibility = "hidden";
		cat[6] = Math.floor((cat[4]+t)*cat[1]/cat[2])%cat[1];
		cat[5][cat[6]].style.visibility = "visible";
	    });
	}
	window.requestAnimationFrame(animate);
    }
    websocket.onopen = function(){
	window.setInterval(do_ntp,1000);
	do_ntp();
    };
    websocket.onmessage = function(event){
	const now=new Date().getTime();
	if (event.data.slice(0,1)=="t"){
	    timeout = 4;
	    if (ntp_offset==undefined)
		websocket.send("middle");
	    const ntp_t1=parseInt(event.data.slice(1));
	    ntp_offset = (now+ntp_t0)/2-ntp_t1+DELAY;
	}
	if (event.data.slice(0,1)=="k" && ntp_offset!=undefined){
	    const json=JSON.parse(event.data.slice(1));
	    if ("name" in json){
		document.getElementById("name").innerHTML = json.name;
		document.getElementById("title").innerHTML = json.name;
	    }
	    if ("karaoke" in json){
		karaoke = json.karaoke;
		start_time = json.start_time+ntp_offset;
		repeat_time = 0;
		karaoke_index = 0;
		next_line_start = 0;
		which_line = 0;
		cats.forEach(function(cat){
		    cat[4]=0;
		});
		last_cat = 0;
		last_fatcat = 0;
		last_beat_time = undefined;
		ball_x0 = undefined;
		line_events = [];
		beat_events = [];
		lines[0].innerHTML = "";
		lines[1].innerHTML = "";
		window.requestAnimationFrame(animate);
	    }
	    if ("stop" in json)
		start_time = undefined;
	}
    }
</script>
</html>
