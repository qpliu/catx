<!doctype html> 
<html>
<head>
<meta charset=UTF-8>
<title id=title>Karaoke</title>
</head>
<body style=overflow:hidden;>
<a id=setup href=setup.html><img style=position:absolute;right:0;top:0;width:5vw;z-index:9;color:#0f0; src=../settings.svg></a>
<div id=div style=position:absolute;left:0;top:10vh;width:100vw;></div>
<div style=position:absolute;top:0;left:0;width:100vw;height:10vh;text-align:center;><span id=name style=font-size:6vh;white-space:nowrap;color:#0f0;background-color:#000;></span></div>
<div style=position:absolute;top:10vh;left:0;width:100vw;height:10vh;text-align:center;><span id=beat_counter style=font-family:monospace;font-size:8vh;color:#000;background-color:#0f0;>1</span></div>
<div id=line1at style=position:absolute;top:64vh;left:5vw;width:5vw;font-size:2vw;></div>
<div id=line1 style=position:absolute;top:64vh;left:10vw;width:90vw;font-size:2vw;white-space:nowrap;></div>
<div id=line0at style=position:absolute;top:85vh;left:15vw;width:5vw;font-size:2vw;></div>
<div id=line0 style=position:absolute;top:85vh;left:20vw;width:80vw;font-size:2vw;white-space:nowrap;></div>
<div id=lineatat style=position:absolute;top:100vh;left:97.5vw;height:0;></div>
<img id=ball style=position:absolute;bottom:100vh;width:5vw;z-index:2; src=../ball.png>
<div style=position:absolute;left:0;top:35vh;width:100vw;height:65vh;z-index:-9;text-align:center;>
<span id=bgtext style=font-size:45vh;margin-top:10vh;color:#0f0;opacity:.5;display:none;></span>
<img id=bgimg style=opacity:.25;margin-left:auto;margin-right:auto;height:65vh;display:none;>
</div>
<canvas id=snakes1 style=position:absolute;top:20vh;left:0;width:100vw;height:40vh;background-color:#000;display:none;></canvas>
<div id=snakes1w style=position:absolute;bottom:40vh;left:0;width:100vw;height:5vh;font-size:1vw;white-space:nowrap;color:#0f0;background-color:#000;display:none;z-index:1;></div>
<canvas id=snakes0 style=position:absolute;top:60vh;left:0;width:100vw;height:40vh;background-color:#000;display:none;></canvas>
<div id=snakes0w style=position:absolute;bottom:0vh;left:0;width:100vw;height:5vh;font-size:1vw;white-space:nowrap;color:#0f0;background-color:#000;display:none;z-index:1;></div>
<script>
    const audioContext=new AudioContext();
    const DELAY=200;
    const HARMONICS_TO_CHECK=3;
    const FFT_SIZE=16384;
    const TIME_PER_SNAKE=4000;
    let match=window.location.search.match("[?&]lowestNote=([^?&]+)");
    const MIN_NOTE=match?Number(match[1]):48;
    match = window.location.search.match("[?&]highestNote=([^?&]+)");
    const MAX_NOTE=match?Number(match[1]):72;
    match = window.location.search.match("[?&]minDecibels=([^?&]+)");
    const MIN_DECIBELS=match?Number(match[1]):-100;
    match = window.location.search.match("[?&]maxDecibels=([^?&]+)");
    const MAX_DECIBELS=match?Number(match[1]):-50;
    match = window.location.search.match("[?&]transpose=([^?&]+)");
    const TRANSPOSE=match?Number(match[1]):60;
    match = window.location.search.match("[?&]snakes=([^?&]+)");
    const SNAKES=match?Number(match[1]):0;
    const CANVAS_WIDTH=1024;
    const CANVAS_HEIGHT=(MAX_NOTE-MIN_NOTE)*10;
    const cats=[
	["../cat/cat-${frame}.png",40,8,"position:absolute;left:0;top:0;width:15vw;z-index:-1;"],
	["../cat/fatcat-${frame}.png",8,2,"position:absolute;left:82vw;top:0;width:18vw;z-index:-1;"],
	["../cat/graycat-${frame}.png",4,1,"position:absolute;left:15vw;top:0;width:15vw;z-index:-1;"],
	["../cat/spin-${frame}.png",18,2,"position:absolute;left:30vw;top:0;width:15vw;z-index:-1;"],
	["../cat/pink-${frame}.png",8,2,"position:absolute;left:55vw;top:0;width:18vw;z-index:-1;"],
	["../cat/jump-${frame}.png",8,4,"position:absolute;left:70vw;top:0;width:15vw;z-index:-1;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:-9vw;top:-5vw;width:20vw;z-index:-3;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:2vw;top:-5vw;width:20vw;z-index:-2;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:13vw;top:-5vw;width:20vw;z-index:-3;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:24vw;top:-5vw;width:20vw;z-index:-2;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:35vw;top:-5vw;width:20vw;z-index:-3;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:46vw;top:-5vw;width:20vw;z-index:-2;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:58vw;top:-5vw;width:20vw;z-index:-3;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:69vw;top:-5vw;width:20vw;z-index:-2;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:80vw;top:-5vw;width:20vw;z-index:-3;"],
	["../cat/tree-${frame}.png",52,4,"position:absolute;left:91vw;top:-5vw;width:20vw;z-index:-2;"],
	["../cat/wave-${frame}.jpg",15,4,"position:absolute;left:0;top:-10vw;width:34vw;z-index:-4;"],
	["../cat/wave-${frame}.jpg",15,4,"position:absolute;left:34vw;top:-10vw;width:34vw;z-index:-4;"],
	["../cat/wave-${frame}.jpg",15,4,"position:absolute;left:68vw;top:-10vw;width:34vw;z-index:-4;"],
    ];
    const websocket=new WebSocket("wss://catx.band/karaoke_websocket");
    let fft;
    let fft_data;
    let last_fft_time;
    let last_beat_time;
    let ntp_t0;
    let ntp_offset;
    let karaoke;
    let karaoke_index;
    let start_time;
    let repeat;
    let repeat_time;
    const bgimg=document.getElementById("bgimg");
    document.getElementById("setup").href += window.location.search;
    const bgtext=document.getElementById("bgtext");
    const ball=document.getElementById("ball");
    const beat_counter=document.getElementById("beat_counter");
    const lines=[document.getElementById("line0"),document.getElementById("line1")];
    const snakes=[document.getElementById("snakes0"),document.getElementById("snakes1")];
    const snakesw=[document.getElementById("snakes0w"),document.getElementById("snakes1w")];
    let which_line;
    let snake_time;
    let snake_key;
    let snake_key_time;
    let timeout=4;
    let id_counter=0;
    let line_events;
    let word_element;
    let word_t0;
    let word_t1;
    let ball_events;
    let beat_events;
    let bg_events;
    let next_line_start;
    let ball_x0,ball_y0,ball_t0;
    let ball_x1,ball_y1,ball_t1;
    if (SNAKES){
	for (const i in snakes){
	    snakes[i].style.display = "block";
	    snakes[i].width = CANVAS_WIDTH;
	    snakes[i].height = CANVAS_HEIGHT;
	    snakesw[i].style.display = "block";
	}
	cats.length = 0;
    }else
	for (const cat of cats){
	    const div=document.getElementById("div");
	    l = [];
	    for (let frame=0; frame<cat[1]; frame++){
		const img=document.createElement("img");
		img.src = eval("`"+cat[0]+"`");
		img.style = cat[3];
		div.appendChild(img);
		l.push(img);
		if (frame!=0)
		    img.style.visibility = "hidden";
	    }
	    cat.push(0);
	    cat.push(l);
	    cat.push(0);
	}
    function do_ntp(){
	if (--timeout<0)
	    location.reload();
	ntp_t0 = new Date().getTime();
	websocket.send("ntp");
    }
    function animateBeatEvents(now){
	for (; beat_events.length!=0&&start_time+beat_events[0][0]<now; beat_events=beat_events.slice(1)){
	    last_beat_time = beat_events[0][0];
	    for (const cat of cats)
		cat[4] = (cat[4]+1)%cat[2];
	    beat_counter.innerHTML = beat_events[0][1]
	}
	if (beat_events.length!=0 && last_beat_time!=undefined){
	    const t=(now-start_time-last_beat_time)/(beat_events[0][0]-last_beat_time);
	    for (const cat of cats){
		cat[5][cat[6]].style.visibility = "hidden";
		cat[6] = Math.floor((cat[4]+t)*cat[1]/cat[2])%cat[1];
		cat[5][cat[6]].style.visibility = "visible";
	    }
	}
    }
    function gotAudio(e){
	const now=new Date().getTime();
	console.log(e.inputBuffer.length);
    }
    function animateSnakes(time){
	if (start_time==undefined)
	    return;
	const now=new Date().getTime();
	if (fft!=undefined){
	    let canvas;
	    let canvas_start;
	    if (now<start_time+snake_time-TIME_PER_SNAKE){
		canvas = snakes[which_line^1];
		canvas_start = start_time+snake_time-2*TIME_PER_SNAKE;
	    }else{
		canvas = snakes[which_line];
		canvas_start = start_time+snake_time-TIME_PER_SNAKE;
	    }
	    const context=canvas.getContext("2d");
	    context.globalCompositeOperation = "lighter";
	    const x0=Math.floor(Math.max((last_fft_time-canvas_start)*CANVAS_WIDTH/TIME_PER_SNAKE,0));
	    const x1=Math.floor((now-canvas_start)*CANVAS_WIDTH/TIME_PER_SNAKE);
	    last_fft_time = now;
	    context.globalCompositeOperation = "difference";
	    context.fillStyle = "#404040";
	    context.fillRect(x0,0,x1-x0,CANVAS_HEIGHT);
	    context.globalCompositeOperation = "lighten";
	    fft.getByteFrequencyData(fft_data);
	    const i0=Math.floor(Math.exp((MIN_NOTE-69)/12*Math.log(2))*440*FFT_SIZE/audioContext.sampleRate);
	    const i1=Math.floor(Math.exp((MAX_NOTE-69)/12*Math.log(2))*440*FFT_SIZE/audioContext.sampleRate);
	    for (let i=i0; i<i1; i++){
		const n0=69+Math.log(i*audioContext.sampleRate/FFT_SIZE/440)/Math.log(2)*12;
		const n1=69+Math.log((i+1)*audioContext.sampleRate/FFT_SIZE/440)/Math.log(2)*12;
		const y0=Math.floor((MAX_NOTE-n0)/(MAX_NOTE-MIN_NOTE)*CANVAS_HEIGHT);
		const y1=Math.floor((MAX_NOTE-n1)/(MAX_NOTE-MIN_NOTE)*CANVAS_HEIGHT);
		let d=fft_data[i];
		for (let j=2; i*j<fft_data.length&&j<=HARMONICS_TO_CHECK; j++)
		    d = Math.min(d,fft_data[i*j]);
		context.fillStyle = "rgb("+d+","+d+","+0+")";
		context.fillRect(x0,y0,x1-x0,y1-y0);
	    }
	}
	while (next_line_start<now){
	    snake_time += Math.max(Math.floor((now-start_time-snake_time)/(TIME_PER_SNAKE*2)),0)*TIME_PER_SNAKE*2;
	    which_line ^= 1;
	    sb = ""
	    keys = {}
	    const canvas=snakes[which_line];
	    const context=canvas.getContext("2d");
	    context.globalCompositeOperation = "source-over";
	    context.fillStyle = "#404040";
	    context.fillRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);
	    for (const a of karaoke)
		if ("t" in a){
		    if ("on" in a)
			keys[a.on] = a.t;
		    if ("off" in a && a.off in keys){
			const t0=keys[a.off];
			delete keys[a.off];
			const t1=a.t;
			const y0=(MAX_NOTE-a.off-TRANSPOSE-.5)/(MAX_NOTE-MIN_NOTE)*CANVAS_HEIGHT;
			const y1=(MAX_NOTE-a.off-TRANSPOSE+.5)/(MAX_NOTE-MIN_NOTE)*CANVAS_HEIGHT;
			let r0=0;
			let r1=1;
			if (repeat!=0){
			    r0 = Math.floor((snake_time-t1)/repeat);
			    r1 = Math.ceil((snake_time+TIME_PER_SNAKE-t0)/repeat);
			}
			for (let r=r0; r<r1; r++){
			    const x0=Math.max((t0+repeat*r-snake_time)/TIME_PER_SNAKE,0)*CANVAS_WIDTH;
			    const x1=Math.min((t1+repeat*r-snake_time)/TIME_PER_SNAKE,1)*CANVAS_WIDTH;
			    if (x1>x0){
				context.fillStyle = "#ff40ff";
				context.fillRect(x0,y0,x1-x0,y1-y0);
			    }
			}
		    }
		    if ("k" in a){
			let r0=0;
			let r1=1;
			if (repeat!=0){
			    r0 = Math.ceil((snake_time-TIME_PER_SNAKE-a.t)/repeat);
			    r1 = Math.ceil((snake_time+TIME_PER_SNAKE-a.t)/repeat);
			}
			for (let r=r0; r<r1; r++){
			    const t=a.t+repeat*r;
			    if (t>snake_time-TIME_PER_SNAKE && t<snake_time+TIME_PER_SNAKE)
				for (let k of a.k.split("|")){
				    if (k.slice(0,6)=="!beat="){
					if (t>=snake_time && t<snake_time+TIME_PER_SNAKE)
					    beat_events.push([t,k.slice(6)]);
					if (k.slice(-2)==':1' || k.slice(-2)=='=1')
					    context.fillStyle = "#ff4040";
					else
					    context.fillStyle = "#4040ff";
					const x0=(t-snake_time)/TIME_PER_SNAKE*CANVAS_WIDTH;
					context.fillRect(x0,0,1,CANVAS_HEIGHT);
				    }else if (k.slice(0,4)=="!bg=")
					continue;
				    else{
					if (k.slice(0,1)==">")
					    k = k.slice(1);
					if (k=="@" || k=="@@")
					    continue;
					if (k.slice(0,1)=="-")
					    k = k.slice(1);
					if (k.length!=0)
					    sb += "<span style=position:absolute;left:"+(t-snake_time)*100/TIME_PER_SNAKE+"vw;bottom:0>"+k+"</span>"
				    }
				}
			}
		    }
		}
	    snakesw[which_line].innerHTML = sb;
	    next_line_start = start_time+snake_time+TIME_PER_SNAKE/2;
	    snake_time += TIME_PER_SNAKE;
	}
	beat_events.sort();
	animateBeatEvents(now);
	window.requestAnimationFrame(animateSnakes);
    }
    function animateBall(time){
	if (start_time==undefined)
	    return;
	const now=new Date().getTime();
	while (next_line_start<now && karaoke_index<karaoke.length){
	    which_line ^= 1;
	    let this_line_start;
	    let this_line_end;
	    sb = ""
oo:
	    for (;; karaoke_index++){
		if (karaoke_index>=karaoke.length)
		    if (repeat!=0){
			repeat_time = Math.ceil((now-start_time)/repeat)*repeat;
			karaoke_index = 0;
		    }else
			break;
		const t=karaoke[karaoke_index].t+repeat_time;
		if ("k" in karaoke[karaoke_index])
		    for (let k of karaoke[karaoke_index].k.split("|")){
			if (k.slice(0,6)=="!beat=")
			    beat_events.push([t,k.slice(6)]);
			else if (k.slice(0,4)=="!bg=")
			    bg_events.push([t,k.slice(4)]);
			else{
			    if (k.slice(0,1)==">"){
				if (this_line_start!=undefined)
				    break oo;
				k = k.slice(1);
			    }
			    if (k=="@@"){
				ball_events.push([t,"lineatat"]);
				k = "-";
			    }else if (k=="@"){
				if (which_line==0)
				    ball_events.push([t,"line0at"]);
				else
				    ball_events.push([t,"line1at"]);
				k = "-";
			    }
			    if (k.slice(0,1)=="-")
				k = k.slice(1);
			    else if (sb.length!=0)
				sb += "&nbsp;";
			    sb += "<span style=position:relative;>";
			    sb += "<span style=color:#000;>"+k+"</span>";
			    sb += "<span id=id"+id_counter+" style=overflow:hidden;position:absolute;left:0;width:0;z-index:1;color:#f00;>"+k+"</span>";
			    sb += "</span>";
			    if (k.length!=0){
				this_line_end = t;
				if (this_line_start==undefined)
				    this_line_start = t;
				ball_events.push([t,"id"+id_counter]);
			    }
			    line_events.push([t,"id"+id_counter]);
			    id_counter++;
			}
		    }
	    }
	    lines[which_line].innerHTML = sb;
	    if (this_line_start==undefined)
		next_line_start = now;
	    else
		next_line_start = start_time+(2*this_line_start+this_line_end)/3;
	}
	for (; line_events.length!=0&&start_time+line_events[0][0]<now; line_events=line_events.slice(1)){
	    if (word_element!=null)
		word_element.style.overflow = "visible";
	    word_element = document.getElementById(line_events[0][1]);
	    if (word_element!=null){
		word_t0 = start_time+line_events[0][0];
		word_t1 = line_events.length>1?start_time+line_events[1][0]:now;
	    }
	}
	if (word_element!=null)
	    word_element.style.width = (now-word_t0)/(word_t1-word_t0)*100+"%";
	for (; line_events.length!=0&&start_time+line_events[0][0]<now; line_events=line_events.slice(1)){
	    let element=document.getElementById(line_events[0][1]);
	    if (element==null)
		continue;
	    element.style.color = '#f00';
	}
	for (; ball_t1<now&&ball_events.length!=0; ball_events=ball_events.slice(1)){
	    let element=document.getElementById(ball_events[0][1]);
	    if (element==null)
		continue;
	    const rect=element.getBoundingClientRect();
	    ball_t0 = ball_t1;
	    ball_x0 = ball_x1;
	    ball_y0 = ball_y1;
	    ball_t1 = start_time+ball_events[0][0];
	    ball_x1 = rect.left;
	    ball_y1 = rect.top;
	}
	if (ball_t0!=undefined){
	    const tt=ball_t1-ball_t0;
	    const t=Math.min((now-ball_t0)/tt,1);
	    const r=ball.getBoundingClientRect();
	    ball.style.left = (ball_x0+t*(ball_x1-ball_x0)+(r.left-r.right)/2)+"px";
	    const bounce_height=2*(r.bottom-r.top);
	    ball.style.top = (ball_y0+t*(ball_y1-ball_y0)-r.bottom+r.top-(1-4*(t-.5)*(t-.5))*bounce_height*Math.min(tt/2000,1))+"px";
	}
	for (; bg_events.length!=0&&start_time+bg_events[0][0]<now; bg_events=bg_events.slice(1)){
	    const k=bg_events[0][1];
	    bgimg.style.display = "none";
	    bgtext.style.display = "none";
	    bgimg.src = "";
	    bgtext.innerHTML = "";
	    if (k.slice(0,4)=="img="){
		bgimg.src = k.slice(4);
		bgimg.style.display = "block";
	    }else{
		bgtext.innerHTML = k;
		bgtext.style.display = "block";
	    }
	}
	animateBeatEvents(now);
	window.requestAnimationFrame(animateBall);
    }
    websocket.onopen = function(){
	window.setInterval(do_ntp,1000);
	do_ntp();
    };
    websocket.onmessage = function(event){
	const now=new Date().getTime();
	if (event.data.slice(0,1)=="t"){
	    timeout = 4;
	    if (ntp_offset==undefined)
		websocket.send("middle");
	    const ntp_t1=parseInt(event.data.slice(1));
	    ntp_offset = (now+ntp_t0)/2-ntp_t1+DELAY;
	}
	if (event.data.slice(0,1)=="k" && ntp_offset!=undefined){
	    const json=JSON.parse(event.data.slice(1));
	    if ("name" in json){
		document.getElementById("name").innerHTML = json.name;
		document.getElementById("title").innerHTML = json.name;
	    }
	    if ("karaoke" in json){
		karaoke = json.karaoke;
		start_time = json.start_time+ntp_offset;
		snake_time = 0;
		last_fft_time = start_time;
		snake_key = undefined;
		repeat = karaoke.length>0 && "repeat" in karaoke[karaoke.length-1]?karaoke[karaoke.length-1].repeat:0;
		repeat_time = repeat==0?0:Math.max(Math.floor((now-start_time)/repeat)*repeat,0);
		karaoke_index = 0;
		next_line_start = 0;
		which_line = 0;
		for (const cat of cats)
		    cat[4] = 0;
		last_cat = 0;
		last_fatcat = 0;
		last_beat_time = undefined;
		ball_t0 = undefined;
		ball_t1 = start_time;
		word_element = null;
		line_events = [];
		ball_events = [];
		beat_events = [];
		bg_events = [];
		lines[0].innerHTML = "";
		lines[1].innerHTML = "";
		bgimg.style.display = "none";
		bgtext.style.display = "none";
		window.requestAnimationFrame(SNAKES?animateSnakes:animateBall);
	    }
	    if ("stop" in json)
		start_time = undefined;
	}
    }
    async function gotUserMedia(stream){
	const microphone=audioContext.createMediaStreamSource(stream);
	fft = audioContext.createAnalyser();
	fft.smoothingTimeConstant = 0;
	fft.fftSize = FFT_SIZE;
	fft.maxDecibels = MAX_DECIBELS;
	fft.minDecibels = MIN_DECIBELS;
	microphone.connect(fft);
	fft_data = new Uint8Array(fft.frequencyBinCount);
    }
    if (SNAKES)
	navigator.mediaDevices.getUserMedia({audio:true}).then(gotUserMedia).catch(function(err){alert(err);});
</script>
</html>
