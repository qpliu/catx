#!/bin/sh
set -e
out1=
comma1=
for a in src-*/out.pdf
do
    if test -f "$a"
    then
	d=`dirname "$a"`
	part=`echo "$d"|cut -c 5-`
	out2=
	comma2=
	p=1
	last=
	bad=
	got=
	m=0
	while pdftohtml -f $p -l $p "$a" "$d/html$p" >/dev/null 2>&1
	do
	    sed <"$d/html${p}s.html" >"$d/numbers$p" -n -e 's/^\([1-9][0-9]*\)<br\/>$/\1/p'
	    mm=
	    while read -r n
	    do
		if test "$m" -lt "$n"
		then
		    m="$n"
		    mm="$mm
$n"
		fi
	    done <"$d/numbers$p"
	    next=`echo "$mm"|head -n 3|tail -n 1`
	    if test -z "$next"
	    then
		next=undefined
		if test "$p" -gt 1
		then
		    bad=1
		fi
	    fi
	    got="$got $next"
	    if test "$p" -gt 2
	    then
		out2="$out2$comma2[$last,1]"
		comma2=,
	    fi
	    last="$next"
	    p=`echo "print $p+1"|python`
	done
	if test -n "$bad"
	then
	    echo "# \"$part\":$got"
	else
	    out1="$out1$comma1\"$part\":[$out2]"
	    comma1=,
	fi
    fi
done
echo "generatedPageTurns={$out1}"
