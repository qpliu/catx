#!/bin/sh
exec 2>&1
HAVE_TIMIDITY=`type timidity >/dev/null 2>&1;echo $?`
HAVE_FFMPEG=`type ffmpeg >/dev/null 2>&1;echo $?`
set -e
pwd=`pwd`
name=`basename "$pwd"`
if test '!' -f "../buildBin"
then
    echo "Wrong directory.  Run this from one of src/*/ directories."
    exit 1
fi
cd ../../build/
PARTS="$*"
rm -rf bin
mkdir -p bin/bin
mkdir -p bin/src
mkdir -p bin/java
cd bin/java
ln ../../java/* .
javac -Xlint *.java
cd ../..
ln *.i *.wav timidity_extra_silence.cfg bin/src
cp "../src/$name"/* bin/src
cd bin/src
if test -x "run_before"
then
    ./run_before
fi
for a in *tabs
do
    if test -f "$a"
    then
	echo "$a"
	aa=`basename "$a" tabs`
	../../tabsToLy.py <"$a" >"$aa"
    fi
done
for a in *colors
do
    if test -f "$a"
    then
	aa=`basename "$a" colors`
	../../synesthesia.py <"$a" >"$aa"
    fi
done
for a in *text
do
    if test -f "$a"
    then
	../../dotext.py <"$a" "${a}_"
    fi
done
for a in *.mp3
do
    if test -f "$a" -a "$HAVE_FFMPEG" = 0
    then
	b=`basename "$a" .mp3`
	ffmpeg </dev/null -loglevel 16 -i "$a" "$b".wav
    fi
done
echo "name=$name" >"../bin/$name.aarin"
sed <music -n -e 's/^% ROBOT \(.*\)$/\1/p' >>"../bin/$name.aarin"
MIDIMERGE=`sed <music -n -e 's/^% MIDIMERGE \(.*\)$/\1/p'`
for part in $PARTS
do
    mkdir "../src-$part"
    for a in *
    do
	sed "s/^%[ 	]*IF[ 	][ 	]*$part[ 	]//;s/^%[ 	]*IFNOT[ 	][ 	]*$part[ 	]/% /;s/^%[ 	]*IFNOT[ 	][ 	]*[^ 	]*//"  <"$a" >"../src-$part/$a"
    done
    cd "../src-$part"
    if test "x$part" = "xmidi"
    then
	merge="$MIDIMERGE"
	for midi in midiCue midiGg midiPeter midiKav midiSusan midiKaraoke midiKaraokeTwo midiOne midiTwo midiThree midiFour
	do
	    cat <<EOF >"$name-$midi.ly"
\version "2.20.0"
\include "articulate.ly"
\include "header.i"
\include "music"
\score {
\unfoldRepeats \articulate \keepWithTag #'($midi keep) \removeWithTag #'(removeWithUnfold) \midimusic
\midi { }
}
EOF
	    lilypond -l WARN -o "$midi" "$name-$midi.ly"
	    merge="$merge $midi.midi"
	done
	java -cp ../java MergeMidi $merge >"$name.midi"
        if test "$HAVE_TIMIDITY" = 0 -a "$HAVE_FFMPEG" = 0
	then
	    TIMIDITY_EXTRA_CFG="-c timidity_extra_silence.cfg"
	    if test -f timidity_extra.cfg
	    then
		TIMIDITY_EXTRA_CFG="$TIMIDITY_EXTRA_CFG -c timidity_extra.cfg"
	    fi
	    timidity $TIMIDITY_EXTRA_CFG -OF -o "$name.flac" -A400 "$name.midi"
	    ffmpeg </dev/null -loglevel 16 -i "$name.flac" "$name.mp3"
	    cp "$name.midi" ../bin
	    if test -d /share/music
	    then
		cp "$name.mp3" /share/music/mp3
		cp "$name.midi" "/share/music/midi/$name.midi"
		echo "midi_file=../midi/$name.midi" >>../bin/"$name.aarin"
	    fi
        fi
    else
	n="${name}_$part"
	part1=`echo $part|sed 's/1/One/g;s/2/Two/g;s/3/Three/g;s/4/Four/g;s/5/Five/g;s/6/Six/g;s/7/Seven/g;s/8/Eight/g'`
	for paper in letter 8x9
	do
	    cat <<EOF >"$n-$paper.ly"
\version "2.20.0"
\include "header.i"
\paper { #(set-paper-size "$paper") }
\include "music"
\score {
\keepWithTag #'(${part1}Part keep) \layoutmusic
\layout {
    indent = 0\cm
    short-indent = 0\cm
    ragged-last = ##t
}
}
EOF
	    lilypond -l WARN -o "$n-$paper" "$n-$paper.ly"
	done
	cp "$n-letter.pdf" "../bin/$n.pdf"
	case "$n" in
	    *_gg)
		echo "default_pdf_file=../pdf/$n.pdf" >>"../bin/$name.aarin"
		;;
	esac
	echo "pdf_file=../pdf/$n.pdf" >>"../bin/$name.aarin"
	if test -d /share/music
	then
	    cp "$n-letter.pdf" "/share/music/pdf/$n.pdf"
	    cp "$n-8x9.pdf" "/share/music/8x9/$n.pdf"
	    rm -f /share/music/svg/"${n}_"*
	    page=1
	    while pdf2svg "$n-8x9.pdf" /share/music/svg/"${n}_$page.svg" $page
	    do
		gzip /share/music/svg/"${n}_$page.svg"
		page=`echo print $page+1|python`
	    done
	fi
    fi
    cd ../src
done
if test -d /share/music
then
    cp "../bin/$name.aarin" /share/music/aarin
fi
